@page "/presents"
@attribute [Authorize]

@using Christmas.Components.MongoDbCollections
@using Christmas.Components.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims

@inject ChristmasPresentService ChristmasPresentService

<AuthorizeView>
    <Authorized>
        You're authorized!!
        @foreach(ChristmasPresent present in GetChristmasPresentsForOtherUsers()){
            <p>@present.recipient</p>
        }
    </Authorized>
    <NotAuthorized>You are not authorized, please <a href="/login">login!</a></NotAuthorized>
</AuthorizeView>

@code {
    [CascadingParameter]
    private Task<AuthenticationState>? authenticationState { get; set; }

    private ClaimsPrincipal User{ get; set; }

    protected async override Task OnInitializedAsync()
    {
        User = (await authenticationState).User;

        await base.OnInitializedAsync();
    }

    private IEnumerable<ChristmasPresent> GetChristmasPresentsForOtherUsers() => ChristmasPresentService.GetPresentsForNotThisUser(User.FindFirstValue("name"));
}
